variables:
  BUCKET_NAME: $BUCKET_NAME
  NAMESPACE: $LZTEAM_NAMESPACE
  PROXY_SERVER: $PROXY_SERVER
  PR_TEST_CASES_ZIP: $PR_TEST_CASES_ZIP
  MERGE_TEST_CASES_ZIP: $MERGE_TEST_CASES_ZIP
  MERGE_BUCKET_NAME: $MERGE_BUCKET_NAME
  MERGE_NAMESPACE: $MERGE_NAMESPACE
  PAR_LOCATION: ""
  PLAN_PIPELINE_TAR: "plan-$TIMESTAMP-$CI_PIPELINE_ID.tar.gz"
  MERGE_PIPELINE_TAR: "merge-$TIMESTAMP-$CI_PIPELINE_ID.tar.gz"


workflow:
  rules:
    - changes:
        - "**/*.tf" # triggers if any file ending in .tf in any dir is changed
      when: always
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: always
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: always
    - when: never  # pipeline isn't triggered if conditions above aren't met


core-lz-prep-test-cases-pull:
  stage: tf-prep-test-case-pull
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push"'

  script:
    - set -o pipefail
    - echo "  ----- BEGIN - Running Test Cases on Pull Request -----  "
    - export https_proxy=$PROXY_SERVER:80
    - export http_proxy=$PROXY_SERVER:80
    - oci os object get -bn $BUCKET_NAME --file $PR_TEST_CASES_ZIP --name $PR_TEST_CASES_ZIP -ns $LZTEAM_NAMESPACE
    - unzip $PR_TEST_CASES_ZIP
    - export TEST_CASES_DIR=${PR_TEST_CASES_ZIP::-4}
    - echo $TEST_CASES_DIR
    - terraform fmt
    - python3 /home/gitlab-runner/pipeline-tools/preprocessor.py $TEST_CASES_DIR -f tfvars.template -d . --plan
    - echo "  ----- END - Running Test for Pull Request Cases -----  "

core-lz-prep-test-cases-merge-pre:
  stage: tf-prep-test-cases-merge-pre
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

  script:
    - set -o pipefail
    - echo "  ----- BEGIN - Running Test Cases on Pull Request -----  "
    - export https_proxy=$PROXY_SERVER:80
    - export http_proxy=$PROXY_SERVER:80
    - TIMESTAMP=$(date +"%Y-%m-%dT%H-%M")
    - echo $TIMESTAMP
    - PLAN_PIPELINE_TAR=$plan-$TIMESTAMP-$CI_PIPELINE_ID.tar.gz
    - oci os object get -bn $BUCKET_NAME --file $MERGE_TEST_CASES_ZIP --name $MERGE_TEST_CASES_ZIP -ns $LZTEAM_NAMESPACE
    - unzip $MERGE_TEST_CASES_ZIP
    - export MERGE_TEST_CASES_DIR=${MERGE_TEST_CASES_ZIP::-4}
    - echo $MERGE_TEST_CASES_DIR
    - terraform fmt
    - python3 /home/gitlab-runner/pipeline-tools/preprocessor_new.py $MERGE_TEST_CASES_DIR -f tfvars.template -d . --plan --merge
    - echo "  ----- BEGIN - Packaging Output -----  "
    - cp *.json $MERGE_TEST_CASES_DIR
    - tar -czvf $PLAN_PIPELINE_TAR $MERGE_TEST_CASES_DIR
    - echo "  ----- SUCCESS - Packaging Output -----  "
    - echo "  ----- BEGIN - Uploading Output to Bucket  -----  "
    - UPLOAD_REQUEST=$(oci os object put -bn $MERGE_BUCKET_NAME -ns $MERGE_NAMESPACE --file $PLAN_PIPELINE_TAR --profile merge)
    - echo $UPLOAD_REQUEST
    - echo "  ----- SUCCESS - Uploading Output to Bucket  -----  "
    - echo "  ----- BEGIN - Creating PAR  -----  "
    - PAR_DATETIME=$(date --date="+24 hours" --rfc-3339=seconds)
    - echo " PAR Expiration is - $PAR_DATETIME "
    - PAR_LOCATION=$(oci os preauth-request create --access-type AnyObjectRead --bucket-name $MERGE_BUCKET_NAME --namespace-name $MERGE_NAMESPACE --time-expires "$PAR_DATETIME" --name $PLAN_PIPELINE_TAR --object-name $PLAN_PIPELINE_TAR --profile merge --query data.\"full-path\")
    - echo "  ----- SUCCESS - Creating PAR  -----  "
    - echo "  ----- PAR Location  -----  "
    - PAR_LOCATION+=$PLAN_PIPELINE_TAR
    - echo $PAR_LOCATION
    - echo "  ----- BEGIN - Clean Script Execution -----  "
    - echo $PAR_LOCATION | tr -d '"'
    - echo "  ----- END - Running Test for Pull Request Cases -----  "



core-lz-merge-test-case-1:
  stage: tf-merge-test-case-1
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: manual
    - if: '$CI_PIPELINE_SOURCE == "push"'
  
  script:
    - set -o pipefail
    - export PATH="$HOME/.local/bin:$PATH"
    - TIMESTAMP=$(date +"%Y-%m-%dT%H-%M")
    - echo $TIMESTAMP
    - MERGE_PIPELINE_TAR=merge-$TIMESTAMP-$CI_PIPELINE_ID.tar.gz
    - echo "  ----- BEGIN - Running Test Cases on Pull Request -----  "
    - export https_proxy=$PROXY_SERVER:80
    - export http_proxy=$PROXY_SERVER:80
    - oci os object get -bn $BUCKET_NAME --file $MERGE_TEST_CASES_ZIP --name $MERGE_TEST_CASES_ZIP -ns $LZTEAM_NAMESPACE
    - unzip $MERGE_TEST_CASES_ZIP
    - export MERGE_TEST_CASES_DIR=${MERGE_TEST_CASES_ZIP::-4}
    - echo $MERGE_TEST_CASES_DIR
    - terraform fmt
    - echo "  ----- BEGIN - Running CIS Compliance Script pre deployment  -----  "
    - wget -O cis_reports.py https://raw.githubusercontent.com/oci-landing-zones/oci-cis-landingzone-quickstart/main/scripts/cis_reports.py
    - python3 cis_reports.py -t merge --report-directory $CI_PIPELINE_ID
    - mkdir $MERGE_TEST_CASES_DIR/predeploy
    - mv $CI_PIPELINE_ID $MERGE_TEST_CASES_DIR/predeploy
    - echo "  ----- BEGIN - Running Terraform Plan  -----  "
    - python3 /home/gitlab-runner/pipeline-tools/preprocessor_new.py $MERGE_TEST_CASES_DIR -f tfvars.template -d . --plan --merge
    - echo "  ----- SUCCESS - Running Terraform Plan  -----  "
    - echo "  ----- BEGIN - Checkov scan on Terraform plan JSON -----  "
    # If PATH is needed: export PATH="$HOME/.local/bin:$PATH"
    - PLAN_JSON=$(ls -1 *_plan.json 2>/dev/null | head -n1)
    - if [ -z "$PLAN_JSON" ]; then
        echo "No *_plan.json found in $(pwd). Plan likely failed or was written elsewhere.";
        exit 1;
      fi
    - CHECKOV_TXT="${CI_PIPELINE_ID}_checkov_results.txt"
    - echo "Scanning $PLAN_JSON"
    - echo "setting http schema to proxies"
    - export http_proxy="http://$PROXY_SERVER:80";
    - export https_proxy="http://$PROXY_SERVER:80";
    - checkov -f "$PLAN_JSON" -o cli > "$CHECKOV_TXT" || true
    # Move into test-cases dir so your tar/upload includes it
    - mv "$CHECKOV_TXT" "$MERGE_TEST_CASES_DIR"/ || true
    - echo "  ----- SUCCESS - Checkov scan on Terraform plan JSON -----  "
    - echo "  ----- BEGIN - Running Terraform Apply  -----  "
    - python3 /home/gitlab-runner/pipeline-tools/preprocessor_new.py $MERGE_TEST_CASES_DIR -f tfvars.template -d . --apply --merge
    - echo "  ----- SUCCESS - Running Terraform Apply  -----  "
    - echo "  ----- BEGIN - Running CIS Compliance Script  -----  "
    - python3 cis_reports.py -t merge --report-directory $CI_PIPELINE_ID
    - mkdir $MERGE_TEST_CASES_DIR/postdeploy
    - mv $CI_PIPELINE_ID $MERGE_TEST_CASES_DIR/postdeploy
    - echo "  ----- SUCCESS - Running CIS Compliance Script  -----  "
    - echo "  ----- BEGIN - Running Terraform Destroy  -----  "
    - python3 /home/gitlab-runner/pipeline-tools/preprocessor_new.py $MERGE_TEST_CASES_DIR -f tfvars.template -d . --destroy --merge
    - echo "  ----- SUCCESS - Running Terraform Destroy  -----  "
    - echo "  ----- BEGIN - Packaging Use Case Output -----  "
    - cp *.json $MERGE_TEST_CASES_DIR
    - cp *.txt $MERGE_TEST_CASES_DIR
    - tar -czvf $MERGE_PIPELINE_TAR $MERGE_TEST_CASES_DIR
    - echo "  ----- SUCCESS - Packaging Use Case Output Output -----  "
    - echo "  ----- BEGIN - Uploading Output to Bucket  -----  "
    - UPLOAD_REQUEST=$(oci os object put -bn $MERGE_BUCKET_NAME -ns $MERGE_NAMESPACE --file $MERGE_PIPELINE_TAR --profile merge)
    - echo $UPLOAD_REQUEST
    - echo "  ----- SUCCESS - Uploading Output to Bucket  -----  "
    - echo "  ----- BEGIN - Creating PAR  -----  "
    - PAR_DATETIME=$(date --date="+24 hours" --rfc-3339=seconds)
    - echo " PAR Expiration is - $PAR_DATETIME "
    - PAR_LOCATION=$(oci os preauth-request create --access-type AnyObjectRead --bucket-name $MERGE_BUCKET_NAME --namespace-name $MERGE_NAMESPACE --time-expires "$PAR_DATETIME" --name $MERGE_PIPELINE_TAR --object-name $MERGE_PIPELINE_TAR --profile merge --query data.\"full-path\")
    - echo "  ----- SUCCESS - Creating PAR  -----  "
    - echo "  ----- PAR Location  -----  "
    - PAR_LOCATION+=$MERGE_PIPELINE_TAR
    - echo $PAR_LOCATION
    # - echo "  ----- BEGIN - Clean Script Execution -----  "
    # - cd /tmp 
    # - rm -rf $PIPELINE_TAR
    # - rm -rf $CI_PIPELINE_ID
    - echo $PAR_LOCATION | tr -d '"'
    - echo "--- Copying TAR file to /tmp for CIS compliance job ---"
    - cp $MERGE_PIPELINE_TAR /tmp/${CI_PIPELINE_ID}_cis_reports.tar.gz
    - echo "âœ… TAR file copied to /tmp/${CI_PIPELINE_ID}_cis_reports.tar.gz"
    - echo "ðŸ” Full path -> $(pwd)/$MERGE_PIPELINE_TAR â†’ /tmp/${CI_PIPELINE_ID}_cis_reports.tar.gz"
    - echo "  ----- END - Running Test for Merge Request Cases -----  "



core-lz-cis-compliance-verification:
  stage: tf-merge-test-case-2
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
  # when: manual
  script:
    - set -o pipefail
    - echo "  ----- BEGIN --- CIS Compliance Verification --- "
    - export https_proxy=$PROXY_SERVER:80
    - export http_proxy=$PROXY_SERVER:80
    - echo "--- Finding latest merge results ---"
    - MERGE_PIPELINE_TAR="/tmp/${CI_PIPELINE_ID}_cis_reports.tar.gz"
    - echo "--- Extracting CIS reports ---"
    - tar -xzvf $MERGE_PIPELINE_TAR
    - |
      MERGE_TEST_CASES_DIR="core-lz-apply-cases"
      echo "Reports directory: $MERGE_TEST_CASES_DIR"
    # Download comparison tools
    - echo "--- Downloading CIS compliance checker ---"
    - oci os object get -bn $BUCKET_NAME --file comparison-tools.zip --name comparison-tools.zip -ns $LZTEAM_NAMESPACE
    - unzip comparison-tools.zip
    # Clean up of old files
    - |
      echo "--- Cleaning up old temporary files ---"
      # Remove TAR files older than 5 days
      find /tmp -name "*_cis_reports.tar.gz" -mtime +5 -type f -exec rm -f {} \; -print
    - echo "âœ… Old temporary files cleaned up"
    # Run compliance check
    - echo "--- Running CIS compliance verification ---"
    - |
      python3 tools/security_check.py \
        --pre-report "$MERGE_TEST_CASES_DIR/predeploy/${CI_PIPELINE_ID}/cis_summary_report.csv" \
        --post-report "$MERGE_TEST_CASES_DIR/postdeploy/${CI_PIPELINE_ID}/cis_summary_report.csv"